---
title: "W241_Project_Analysis"
author: "Jeffrey Hsu"
date: "04/10/2017"
output: pdf_document
---

```{r echo=FALSE}
library(lmtest)
library(sandwich)
library(Hmisc)
library(lsr)
```

## Load Sales Data

```{r}
SOColumnName <- c("OrderID", "Date", "BuyerID", "NrItems", 
                "OrderValue", "ShippingCost", "OrderTotal", 
                "City", "Country")

# Load Sales Order Data for 2017-03
SO1703 <- read.csv("./data/SoldOrders201703.csv", sep=",")
SO1703 <- subset(SO1703, 
                 select=c(Order.ID,Sale.Date,Buyer.User.ID,
                          Number.of.Items,Order.Value,Shipping, 
                          Order.Total,Ship.City,Ship.Country))
colnames(SO1703) <- SOColumnName
SO1703$Date <- as.Date(SO1703$Date,format = "%m/%d/%y")

# Load Sales Order Data for 2017-04
SO1704 <- read.csv("./data/SoldOrders201704.csv", sep=",")
SO1704 <- subset(SO1704, 
                 select=c(Order.ID,Sale.Date,Buyer.User.ID,
                          Number.of.Items,Order.Value,Shipping, 
                          Order.Total,Ship.City,Ship.Country))
colnames(SO1704) <- SOColumnName
SO1704$Date <- as.Date(SO1704$Date,format = "%m/%d/%y")

SO1617 <- read.csv("./data/SoldOrders201609-201702.csv",sep=",")
SO1617 <- subset(SO1617, 
                 select=c(Order.ID,Sale.Date,Buyer.User.ID,
                          Number.of.Items,Order.Value,Shipping, 
                          Order.Total,Ship.City,Ship.Country))
colnames(SO1617) <- SOColumnName
SO1617$Date <- as.Date(SO1617$Date,format = "%m/%d/%y")

# Merge into 1 sales order dataset
SO <- rbind(SO1704, SO1703)
SO <- rbind(SO, SO1617)

## Load Sales Order Item data
SOI1703 <- read.csv("./data/SoldOrderItems201703.csv", sep=",")
SOI1704 <- read.csv("./data/SoldOrderItems201704.csv", sep=",")
```

transform into treatment and control datasets
```{r}
str(SO)
SO_cont1 <- subset(SO, SO$Date > "2017-03-12" & SO$Date < "2017-03-20")
SO_treat <- subset(SO, SO$Date > "2017-03-19" & SO$Date < "2017-03-27")
SO_cont2 <- subset(SO, SO$Date > "2017-03-26" & SO$Date < "2017-04-03")
SO_cont3 <- subset(SO, SO$Date > "2017-04-02" & SO$Date < "2017-04-10")
SO_base <- subset(SO, SO$Date < "2017-03-13")
```

## Load Websession Data

```{r}
session_control1 <- read.csv("./data/websession_control1.csv", sep=",")
session_control2 <- read.csv("./data/websession_control2.csv", sep=",")
session_control3 <- read.csv("./data/websession_control3.csv", sep=",")
session_treatment <- read.csv("./data/websession_treatment.csv", sep=",")
```

## Transform and merge session data

```{r}

```

## Load Demographic Data

```{r}
d_age <- read.csv("./data/GA_age.csv", sep=",")
d_gender <- read.csv("./data/GA_gender.csv", sep=",")
```

## Data Combine

## Covariate Balance

Covariate Balance checks that other factors of sales stays in similar level across control and treatment weeks. This assures the randomness of treatment or control given a single website visit.

### Age

```{r}
## -----Contorl week 1 V.s. Treatment Week-----

# Check balance cont1 v.s. treat of age group 18-24
t.test(as.numeric(d_age[1,2:8]),as.numeric(d_age[1,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[1,2:8]),as.numeric(d_age[1,9:15]), paired = TRUE)

# Check balance cont1 v.s. treat of age group 15-34
t.test(as.numeric(d_age[2,2:8]),as.numeric(d_age[2,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[2,2:8]),as.numeric(d_age[2,9:15]), paired = TRUE)

# Check balance cont1 v.s. treat of age group 35-44
t.test(as.numeric(d_age[3,2:8]),as.numeric(d_age[3,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[3,2:8]),as.numeric(d_age[3,9:15]), paired = TRUE)

# Check balance cont1 v.s. treat of age group 45-54
t.test(as.numeric(d_age[4,2:8]),as.numeric(d_age[4,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[4,2:8]),as.numeric(d_age[4,9:15]), paired = TRUE)

# Check balance cont1 v.s. treat of all age groups
t.test(as.numeric(d_age[5,2:8]),as.numeric(d_age[5,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[5,2:8]),as.numeric(d_age[5,9:15]), paired = TRUE)

# Check age composition balance of cont1 v.s. treat
cont1_age_comp <- c( rep(21,sum(d_age[1,2:8])), 
                     rep(29.5,sum(d_age[2,2:8])),
                     rep(39.5,sum(d_age[3,2:8])),
                     rep(49.5,sum(d_age[4,2:8])) )
treat_age_comp <- c( rep(21,sum(d_age[1,9:16])), 
                     rep(29.5,sum(d_age[2,9:16])),
                     rep(39.5,sum(d_age[3,9:16])),
                     rep(49.5,sum(d_age[4,9:16])) )
t.test(cont1_age_comp, treat_age_comp)
wilcox.test(cont1_age_comp, treat_age_comp)

## -----Contorl week 2 V.s. Treatment Week-----

# Check balance cont2 v.s. treat of age group 18-24
t.test(as.numeric(d_age[1,16:22]),as.numeric(d_age[1,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[1,16:22]),as.numeric(d_age[1,9:15]), paired = TRUE)

# Check balance cont2 v.s. treat of age group 25-34
t.test(as.numeric(d_age[2,16:22]),as.numeric(d_age[2,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[2,16:22]),as.numeric(d_age[2,9:15]), paired = TRUE)

# Check balance cont2 v.s. treat of age group 35-44
t.test(as.numeric(d_age[3,16:22]),as.numeric(d_age[3,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[3,16:22]),as.numeric(d_age[3,9:15]), paired = TRUE)

# Check balance cont2 v.s. treat of age group 45-54
t.test(as.numeric(d_age[4,16:22]),as.numeric(d_age[4,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[4,16:22]),as.numeric(d_age[4,9:15]), paired = TRUE)

# Check balance cont2 v.s. treat of all age groups
t.test(as.numeric(d_age[5,16:22]),as.numeric(d_age[5,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_age[5,16:22]),as.numeric(d_age[5,9:15]), paired = TRUE)

# Check age composition balance of cont2 v.s. treat
cont2_age_comp <- c( rep(21,sum(d_age[1,16:22])), 
                     rep(29.5,sum(d_age[2,16:22])),
                     rep(39.5,sum(d_age[3,16:22])),
                     rep(49.5,sum(d_age[4,16:22])) )
t.test(cont2_age_comp, treat_age_comp)
wilcox.test(cont2_age_comp, treat_age_comp)

## -----Contorl week 2 V.s. Control Week 1-----

# Check balance cont2 v.s. cont1 of age group 18-24
t.test(as.numeric(d_age[1,16:22]),as.numeric(d_age[1,2:8]), paired = TRUE)
wilcox.test(as.numeric(d_age[1,16:22]),as.numeric(d_age[1,2:8]), paired = TRUE)

# Check balance cont2 v.s. cont1 of age group 25-34
t.test(as.numeric(d_age[2,16:22]),as.numeric(d_age[2,2:8]), paired = TRUE)
wilcox.test(as.numeric(d_age[2,16:22]),as.numeric(d_age[2,2:8]), paired = TRUE)

# Check balance cont2 v.s. cont1 of age group 35-44
t.test(as.numeric(d_age[3,16:22]),as.numeric(d_age[3,2:8]), paired = TRUE)
wilcox.test(as.numeric(d_age[3,16:22]),as.numeric(d_age[3,2:8]), paired = TRUE)

# Check balance cont2 v.s. cont1 of age group 45-54
t.test(as.numeric(d_age[4,16:22]),as.numeric(d_age[4,2:8]), paired = TRUE)
wilcox.test(as.numeric(d_age[4,16:22]),as.numeric(d_age[4,2:8]), paired = TRUE)

# Check balance cont2 v.s. cont1 of age group 45-54
t.test(as.numeric(d_age[5,16:22]),as.numeric(d_age[5,2:8]), paired = TRUE)
wilcox.test(as.numeric(d_age[5,16:22]),as.numeric(d_age[5,2:8]), paired = TRUE)

# Check age composition balance of cont2 v.s. cont1
t.test(cont2_age_comp, cont1_age_comp)
wilcox.test(cont2_age_comp, cont1_age_comp)
```

### Gender

```{r}
## -----Control 1 v.s. Treatment-----
wilcox.test(as.numeric(d_gender[1,2:8]),as.numeric(d_gender[1,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_gender[2,2:8]),as.numeric(d_gender[2,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_gender[3,2:8]),as.numeric(d_gender[3,9:15]), paired = TRUE)
cont1_gender_comp <- c(rep(0,sum(d_gender[1,2:8])), rep(1,sum(d_gender[2,2:8])))
treat_gender_comp <- c(rep(0,sum(d_gender[1,9:15])), rep(1,sum(d_gender[2,9:15])))
t.test(cont1_gender_comp, treat_gender_comp)
wilcox.test(cont1_gender_comp, treat_gender_comp)

## -----Control 2 v.s. Treatment-----
wilcox.test(as.numeric(d_gender[1,16:22]),as.numeric(d_gender[1,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_gender[2,16:22]),as.numeric(d_gender[2,9:15]), paired = TRUE)
wilcox.test(as.numeric(d_gender[3,16:22]),as.numeric(d_gender[3,9:15]), paired = TRUE)
cont2_gender_comp <- c(rep(0,sum(d_gender[1,16:22])), rep(1,sum(d_gender[2,16:22])))
t.test(cont2_gender_comp, treat_gender_comp)
wilcox.test(cont2_gender_comp, treat_gender_comp)

## -----Control 2 v.s. Control 1-----
wilcox.test(as.numeric(d_gender[1,16:22]),as.numeric(d_gender[1,2:8]), paired = TRUE)
wilcox.test(as.numeric(d_gender[2,16:22]),as.numeric(d_gender[2,2:8]), paired = TRUE)
wilcox.test(as.numeric(d_gender[3,16:22]),as.numeric(d_gender[3,2:8]), paired = TRUE)
t.test(cont1_gender_comp, cont2_gender_comp)
```

### Country

### Web Sessions of returning and new visitor composition

```{r}
t.test(session_control1$Sessions, session_treatment$Sessions)
t.test(session_control2$Sessions, session_treatment$Sessions)
t.test(session_control1$Sessions, session_control2$Sessions)
```

## Effect Size

```{r}
cohensD(cont1_gender_comp, treat_gender_comp) ## small effect
cohensD(cont1_age_comp, treat_age_comp) ## small effect
cohensD(session_control1$Sessions, session_treatment$Sessions) ## no effect 
```

## Treatment Effects

Below are estimations for treatement effects on sales performance.

```{r}
past_customer <- unique(SO[SO$Date < "2017-03-13",]$BuyerID)
new_customer <- setdiff(unique(SO[SO$Date > "2017-03-12" & SO$Date < "2017-03-27",]$BuyerID),
                                  past_customer)
intersect(unique(SO[SO$Date > "2017-03-12" & SO$Date < "2017-03-20",]$BuyerID),
          unique(SO[SO$Date > "2017-03-19" & SO$Date < "2017-03-27",]$BuyerID))
# there's no customer who placed an order in both control 1 week and treatment week
intersect(unique(SO[SO$Date > "2017-03-26" & SO$Date < "2017-04-09",]$BuyerID),
          unique(SO[SO$Date > "2017-03-19" & SO$Date < "2017-03-27",]$BuyerID))
# there's only 1 buyer that placed an order post treatment 
# that also placed a order during the treatment week

# add new indicator on returning customer orders
SO$Returning_Customer <- as.numeric(SO$BuyerID %in% past_customer)

SO$treat <- as.numeric(SO$Date > "2017-03-19" & SO$Date < "2017-03-27")
```

### Order Value

Control 1 v.s. Treatment
```{r}
# average effect on order value of treatment v.s. control 1
SO_cont1_treat <- SO[SO$Date > "2017-03-12" & SO$Date < "2017-03-27",]
m1_ordervalue <- lm(OrderValue~treat, data=SO_cont1_treat)
summary(m1_ordervalue)
m1_ordervalue$vcov <- vcov(m1_ordervalue)
coeftest(m1_ordervalue, m1_ordervalue$vcov)
# non-parametric test
wilcox.test(SO_cont1$OrderValue,SO_treat$OrderValue)

# ramdomization inference
ate <- mean(SO_treat$OrderValue) - mean(SO_cont1$OrderValue)
dist_sharpnull_ordervalue <- rep(0,10000)
for (i in 1:10000) {
  treat <- sample(SO_cont1_treat$treat)
  dist_sharpnull_ordervalue[i] <- mean(SO_cont1_treat[treat==1,]$OrderValue) -
    mean(SO_cont1_treat[treat==0,]$OrderValue)
}
plot(density(dist_sharpnull_ordervalue), 
     main="Dist. of order value effect under Sharp Null - Contr 1 v.s. Treatment")
abline(v=ate, col="red")
mean(abs(ate) < abs(dist_sharpnull_ordervalue))

# Controlling for returning customer
m2_ordervalue <- lm(OrderValue~treat+Returning_Customer, data=SO_cont1_treat)
summary(m2_ordervalue)
m2_ordervalue$vcov <- vcov(m2_ordervalue)
coeftest(m2_ordervalue, m2_ordervalue$vcov)
```

Compare control 2 to treatment
```{r}
SO_cont2_treat <- SO[SO$Date > "2017-03-19" & SO$Date < "2017-04-03",]
m3_ordervalue <- lm(OrderValue~treat, data=SO_cont2_treat)
summary(m2_ordervalue)
m2_ordervalue$vcov <- vcov(m2_ordervalue)
coeftest(m2_ordervalue, m2_ordervalue$vcov)
# non-parametric test
wilcox.test(SO_cont2$OrderValue,SO_treat$OrderValue)

# ramdomization inference
ate <- mean(SO_treat$OrderValue) - mean(SO_cont2$OrderValue)
dist_sharpnull_ordervalue <- rep(0,10000)
for (i in 1:10000) {
  treat <- sample(SO_cont2_treat$treat)
  dist_sharpnull_ordervalue[i] <- mean(SO_cont2_treat[treat==1,]$OrderValue) -
    mean(SO_cont2_treat[treat==0,]$OrderValue)
}
plot(density(dist_sharpnull_ordervalue), 
     main="Dist. of order value effect under Sharp Null - Contr 2 v.s. Treatment")
abline(v=ate, col="red")
mean(abs(ate) < abs(dist_sharpnull_ordervalue)) # p value under sharp null
```

Intertemperal substitution check

```{r}
wilcox.test(SO_cont2$OrderValue,SO_cont1$OrderValue)
SO_cont1_cont2 <- rbind(SO_cont2,SO_cont1)
ate <- mean(SO_cont2$OrderValue) - mean(SO_cont1$OrderValue)
post_treatment <- c(rep(0,length(SO_cont1$OrderID)), rep(1,length(SO_cont2$OrderID)))
for (i in 1:10000){
        treat <- sample(post_treatment)
        dist_sharpnull_ordervalue[i] <- mean(SO_cont1_cont2[treat==1,]$OrderValue) -
    mean(SO_cont1_cont2[treat==0,]$OrderValue)
}
plot(density(dist_sharpnull_ordervalue), 
     main="Dist. of order value effect under Sharp Null - Contr 2 v.s. Contr 1")
abline(v=ate, col="red")
mean(abs(ate) < abs(dist_sharpnull_ordervalue)) # p value under sharp null
```

### Sales value per Buyer

### Conversion Rate

```{r}

```

### average number of items per order
